# ==========================================
# メイン画面構築
# ==========================================
st.title("📈 フヤセルブレイン - AI理論株価分析ツール")

with st.expander("★ ランク・評価基準の見方（クリックで詳細を表示）", expanded=False):
    st.markdown("""
### 👑 総合ランク（SSS〜E）
理論株価の上昇余地だけでなく、**「大口の動き」「事業の成長性」「財務の安全性」**を総合的にスコア化（100点満点）した格付けです。
- 🟨 **SSS (95-100点)**：**神**。全ての条件が揃った奇跡の銘柄。
- 🟧 **SS (90-94点)**：**最強**。ほぼ死角なし。
- 🟪 **S (85-89点)**：**超優秀**。文句なしの買い候補。
- 🟩 **A (75-84点)**：**優良**。合格点。
- 🟦 **B (60-74点)**：**普通**。悪くはない。
- 🟪 **C〜E**：**微妙〜注意**。

### 1. 割安度評価（★）
**理論株価**（本来の実力）と **現在値** を比較した「お得度」です。
- :red[★★★★★：**お宝**（上昇余地 **+50%** 以上）]
- ★★★★☆：**激アツ**（上昇余地 **+30%** 〜 +50%）
- ★★★☆☆：**有望**（上昇余地 **+15%** 〜 +30%）
- ★★☆☆☆：**普通**（上昇余地 **+5%** 〜 +15%）
- ★☆☆☆☆：**トントン**（上昇余地 **0%** 〜 +5%）
- ☆☆☆☆☆：**割高**（上昇余地 **0% 未満**）

### 2. 売買シグナル（矢印）
| 表示 | 意味 | 判定ロジック |
| :--- | :--- | :--- |
| **↑◎** | **激熱** | **「底値圏」＋「売られすぎ」＋「上昇トレンド」** 等の好条件が3つ以上重なった最強の買い場！ |
| **↗〇** | **買い** | 複数のプラス要素あり。打診買いのチャンス。 |
| **→△** | **様子見** | 可もなく不可もなく。方向感が出るまで待つのが無難。 |
| **↘▲** | **売り** | 天井圏や下落トレンド入り。利益確定や損切りの検討を。 |
| **↓✖** | **危険** | **「買われすぎ」＋「暴落シグナル」** 等が点灯。手を出してはいけない。 |

### 3. 需給の壁（突破力）
**過去6ヶ月間で最も取引が活発だった価格帯（しこり玉・岩盤）** です。
この壁は**「跳ね返される場所（反転）」**であると同時に、**「抜けた後の加速装置（突破）」**でもあります。
- **🚧 上壁（戻り売り圧力）**
    - **【基本】** ここまでは上がっても叩き落とされやすい（抵抗線）。
    - **【突破】** しかしここを食い破れば、売り手不在の**「青天井」**モード突入！
- **🛡️ 下壁（押し目買い支持）**
    - **【基本】** ここで下げ止まって反発しやすい（支持線）。
    - **【割込】** しかしここを割り込むと、ガチホ勢が全員含み損になり**「パニック売り」**が連鎖する恐れあり。
- **🔥 激戦中（分岐点）**
    - まさに今、その壁の中で戦っている。突破するか、跳ね返されるか、要注目！
""", unsafe_allow_html=True) 

st.subheader("🔢 銘柄入力")
# ★修正ポイント：ラベルにも記入例を明記し、placeholderも確実に設定
raw_text = st.text_area("分析したい証券コードを入力してください（※記入例：7203 9984）", height=100, placeholder="例：\n7203\n9984\n285A")
run_btn = st.button("🚀 AIで分析開始！", type="primary")

st.divider()

if "analysis_bundle" not in st.session_state:
    st.session_state["analysis_bundle"] = None
if "analysis_codes" not in st.session_state:
    st.session_state["analysis_codes"] = []

if run_btn:
    raw_codes = raw_text.split()
    codes = sanitize_codes(raw_codes)
    if not codes:
        st.error("証券コードが入力されていません。")
        st.stop()

    with st.spinner(f"🚀 高速分析中..."):
        try:
            bundle = fv.calc_fuyaseru_bundle(codes)
            st.session_state["analysis_bundle"] = bundle
            st.session_state["analysis_codes"] = codes
        except Exception as e:
            st.error(f"エラー: {e}")
            st.stop()

if st.session_state["analysis_bundle"]:
    bundle = st.session_state["analysis_bundle"]
    codes = st.session_state["analysis_codes"]
    
    df = bundle_to_df(bundle, codes)
    
    st.subheader("📊 分析結果")
    st.info("💡 **「詳細」** 列のチェックボックスをONにすると、下に詳細チャートが表示されます！（複数選択OK）")
    
    # ★スタイル適用（ランクに色を付ける）
    styled_df = df.style.map(highlight_errors, subset=["銘柄名"])\
                        .map(highlight_rank_color, subset=["ランク"])
    
    edited_df = st.data_editor(
        styled_df,
        use_container_width=True,
        hide_index=True,
        column_config={
            "詳細": st.column_config.CheckboxColumn(
                "詳細",
                help="チャートを表示",
                default=False,
            ),
            # ★ランク列の設定
            "ランク": st.column_config.TextColumn(
                "ランク",
                help="総合スコア評価（SSS〜E）",
                width="small"
            ),
            "証券コード": st.column_config.TextColumn(disabled=True),
            "銘柄名": st.column_config.TextColumn(disabled=True),
        },
        disabled=["ランク", "証券コード", "銘柄名", "現在値", "理論株価", "上昇余地", "評価", "売買", "需給の壁", "配当利回り", "年間配当", "事業の勢い", "業績", "時価総額", "大口介入", "根拠"]
    )
    
    selected_rows = edited_df[edited_df["詳細"] == True]
    
    # ★複数選択ループ表示
    if not selected_rows.empty:
        for _, row in selected_rows.iterrows():
            selected_code = row["証券コード"]
            ticker_data = bundle.get(selected_code)
            
            if ticker_data and ticker_data.get("name") != "存在しない銘柄" and ticker_data.get("hist_data") is not None:
                st.divider()
                st.markdown(f"### 📉 詳細分析チャート：{ticker_data.get('name')}")
                draw_wall_chart(ticker_data)

    st.info("""
    **※ 評価が表示されない（—）銘柄について**
    赤字決算や財務データが不足している銘柄は、投資リスクの観点から自動的に **「評価対象外」** としています。
    ただし、**「今は赤字だが来期は黒字予想」の場合は、自動的に『予想EPS』を使って理論株価を算出**しています。
    """)

# -----------------------------
# ★豆知識コーナー
# -----------------------------
st.divider()
st.subheader("📚 投資の豆知識・用語解説")

with st.expander("📚 【豆知識】理論株価の計算根拠（グレアム数）とは？"):
    st.markdown("""
    ### 🧙‍♂️ "投資の神様"の師匠が考案した「割安株」の黄金式
    このツールで算出している理論株価は、**「グレアム数」** という計算式をベースにしています。
    これは、あの世界最強の投資家 **ウォーレン・バフェットの師匠** であり、「バリュー投資の父」と呼ばれる **ベンジャミン・グレアム** が考案した由緒ある指標です。

    ### 💡 何がすごいの？
    多くの投資家は「利益（PER）」だけで株を見がちですが、グレアム数は **「企業の利益（稼ぐ力）」** と **「純資産（持っている財産）」** の両面から、その企業が本来持っている **「真の実力値（適正価格）」** を厳しく割り出します。

    **今の株価 ＜ 理論株価（グレアム数）** となっていれば、それは **「実力よりも過小評価されている（バーゲンセール中）」** という強力なサインになります。
    """)

with st.expander("🚀 【注目】なぜ「事業の勢い（売上成長率）」を見るの？"):
    st.markdown("""
    ### 📈 株価を押し上げる"真のエンジン"は売上にあり！
    「利益」は経費削減などで一時的に作れますが、**「売上」** の伸びだけは誤魔化せません。売上が伸びているということは、**「その会社の商品が世の中でバカ売れしている」** という最強の証拠だからです。

    ### 📊 成長スピードの目安（より厳しめのプロ基準）
    - **🚀 +30% 以上： 【超・急成長】**
      驚異的な伸びです。将来のスター株候補の可能性がありますが、期待先行で株価が乱高下するリスクも高くなります。
    - **🏃 +10% 〜 +30%： 【成長軌道】**
      安定してビジネスが拡大しています。安心して見ていられる優良企業のラインです。
    - **🚶 0% 〜 +10%： 【安定・成熟】**
      急成長はしていませんが、堅実に稼いでいます。配当狙いの銘柄に多いです。
    - **📉 マイナス： 【衰退・縮小】**
      去年より売れていません。ビジネスモデルの転換期か、斜陽産業の可能性があります。

    ### 💡 分析のポイント 「赤字 × 急成長」の判断について
    本来、赤字企業は投資対象外ですが、「事業の勢い」が **+30%** を超えている場合は、**「将来のシェア獲得のために、あえて広告や研究に大金を投じている（＝今は赤字を掘っている）」** だけの可能性があります。
    ただし、黒字化できないまま倒産するリスクもあるため、上級者向けの「ハイリスク・ハイリターン枠」として慎重に見る必要があります。
    """)

with st.expander("🌊 ファンドや機関（大口）の\"動き\"を検知する先乗り指標"):
    st.markdown("""
    時価総額や出来高の異常検知を組み合わせ、**「大口投資家が仕掛けやすい（買収や買い上げを狙いやすい）条件」** が揃っているかを%で表示します。

    ### 🔍 判定ロジック
    先乗り（先回り）理論、季節性、対角性、テーマ性、ファンド動向、アクティビスト検知、企業成長性など、ニッチ性、株大量保有条件、あらゆる大口介入シグナルを自動で検出する独自ロジックを各項目ごとにポイント制にしてパーセンテージを算出する次世代の指数

    ### 🎯 ゴールデンゾーン（時価総額 500億〜3000億円）
    機関投資家等が一番動きやすく、TOB（買収）のターゲットにもなりやすい「おいしい規模感」。

    ### 📉 PBR 1倍割れ（バーゲンセール）
    「会社を解散して現金を配った方がマシ」という超割安状態。買収の標的にされやすい。

    ### ⚡ 出来高急増（ボリュームスパイク）
    今日の出来高が、普段の平均より2倍以上ある場合、裏で何かが起きている（誰かが集めている）可能性大！
    **独自の先乗り（先回り）法を完全数値化に成功！ 🔥 80%以上は「激アツ」**
    何らかの材料（ニュース）が出る前触れか、水面下で大口が集めている可能性があります。 大口の買い上げこそ暴騰のチャンスです。この指標もしっかりご確認ください。
    """)

# -----------------------------
# 🔧 管理者メニュー
# -----------------------------
st.divider()
with st.expander("🔧 管理者専用メニュー"):
    admin_input = st.text_input("管理者コード", type="password", key="admin_pass_bottom")
    if admin_input == ADMIN_CODE:
        st.success("認証OK")
        if st.button("🗑️ キャッシュ全削除", type="primary"):
            st.cache_data.clear()
            st.success("削除完了！再読み込みします...")
            time.sleep(1)
            st.rerun()
